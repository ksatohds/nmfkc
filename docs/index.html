<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Non-Negative Matrix Factorization with Kernel Covariates • nmfkc</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Non-Negative Matrix Factorization with Kernel Covariates">
<meta name="description" content="Performs Non-negative Matrix Factorization (NMF) with Kernel Covariates. Given an observation matrix and kernel covariates, it optimizes both a basis matrix and a parameter matrix. Notably, if the kernel matrix is an identity matrix, the method simplifies to standard NMF.">
<meta property="og:description" content="Performs Non-negative Matrix Factorization (NMF) with Kernel Covariates. Given an observation matrix and kernel covariates, it optimizes both a basis matrix and a parameter matrix. Notably, if the kernel matrix is an identity matrix, the method simplifies to standard NMF.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">nmfkc</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.7</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="articles/classification-with-nmfkc.html">Classification with NMF-LAB</a></li>
    <li><a class="dropdown-item" href="articles/introduction-to-nmfkc.html">Introduction to nmfkc</a></li>
    <li><a class="dropdown-item" href="articles/timeseries-with-nmfkc.html">Time Series Analysis with NMF-VAR</a></li>
    <li><a class="dropdown-item" href="articles/topic-modeling-with-nmfkc.html">Topic Modeling with nmfkc</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ksatohds/nmfkc/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="nmfkc-non-negative-matrix-factorization-with-kernel-covariates">nmfkc: Non-negative Matrix Factorization with Kernel Covariates<a class="anchor" aria-label="anchor" href="#nmfkc-non-negative-matrix-factorization-with-kernel-covariates"></a>
</h1></div>
<p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="https://img.shields.io/badge/lifecycle-experimental-orange.svg" alt="Lifecycle: experimental"></a> <a href="https://github.com/ksatohds/nmfkc" class="external-link"><img src="https://img.shields.io/github/r-package/v/ksatohds/nmfkc" alt="GitHub version"></a> <strong>nmfkc</strong> is an R package that extends Non-negative Matrix Factorization (NMF) by incorporating <strong>covariates</strong> using kernel methods. It supports advanced features like rank selection via cross-validation, time-series modeling (NMF-VAR), and supervised classification (NMF-LAB).</p>
</div>
<div class="section level1">
<h1 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h1>
<p>You can install the <strong>nmfkc</strong> package directly from <a href="https://github.com/ksatohds/nmfkc" class="external-link">GitHub</a>.</p>
<div class="section level2">
<h2 id="quick-installation-no-vignettes">Quick Installation (No Vignettes)<a class="anchor" aria-label="anchor" href="#quick-installation-no-vignettes"></a>
</h2>
<p>For the fastest installation without building the package vignettes (tutorials), use the following commands.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># If you don't have the 'remotes' package installed, uncomment the line below:</span></span>
<span><span class="co"># install.packages("remotes")</span></span>
<span></span>
<span><span class="co"># Install the package without building vignettes (default behavior)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"ksatohds/nmfkc"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load the package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ksatohds/nmfkc" class="external-link">nmfkc</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="detailed-installation-with-vignettes">Detailed Installation (With Vignettes)<a class="anchor" aria-label="anchor" href="#detailed-installation-with-vignettes"></a>
</h2>
<p>Recommended if you want to view the tutorials locally.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install the package and build the vignettes</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"ksatohds/nmfkc"</span>, build_vignettes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load the package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ksatohds/nmfkc" class="external-link">nmfkc</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># You can view the vignettes with:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/browseVignettes.html" class="external-link">browseVignettes</a></span><span class="op">(</span><span class="st">"nmfkc"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="alternative-download-source-archive">Alternative Download (Source Archive)<a class="anchor" aria-label="anchor" href="#alternative-download-source-archive"></a>
</h2>
<p>The Package Archive File (.tar.gz) is also available on <a href="https://www.dropbox.com/scl/fo/1jxzzfqz9xsl3wlzwm3pj/ACYDNzn-h54VqgAngTKVyc0?rlkey=i5bcup2qxzwqgles27ke0f9ab&amp;st=mdbkongw&amp;dl=0" class="external-link">Dropbox</a>.</p>
</div>
<div class="section level2">
<h2 id="package-explanation-video">Package Explanation Video<a class="anchor" aria-label="anchor" href="#package-explanation-video"></a>
</h2>
<p>A short video explaining the package can be found here: <a href="https://youtu.be/T48pPGReVu4" class="external-link">YouTube</a></p>
</div>
</div>
<div class="section level1">
<h1 id="help-and-usage">Help and Usage<a class="anchor" aria-label="anchor" href="#help-and-usage"></a>
</h1>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/browseVignettes.html" class="external-link">browseVignettes</a></span><span class="op">(</span><span class="st">"nmfkc"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="st">"package:nmfkc"</span><span class="op">)</span></span>
<span><span class="op">?</span><span class="va">nmfkc</span></span></code></pre></div>
</div>
<div class="section level1">
<h1 id="citation">Citation<a class="anchor" aria-label="anchor" href="#citation"></a>
</h1>
<p>Please use the following command to cite the <strong>nmfkc</strong> package:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ksatohds/nmfkc" class="external-link">nmfkc</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/citation.html" class="external-link">citation</a></span><span class="op">(</span><span class="st">"nmfkc"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level1">
<h1 id="comparison-with-standard-nmf">Comparison with Standard NMF<a class="anchor" aria-label="anchor" href="#comparison-with-standard-nmf"></a>
</h1>
<table class="table">
<thead><tr class="header">
<th align="left">Feature</th>
<th align="left">Standard NMF</th>
<th align="left">nmfkc</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><strong>Handles covariates</strong></td>
<td align="left">No</td>
<td align="left"><strong>Yes</strong></td>
</tr>
<tr class="even">
<td align="left"><strong>Classification</strong></td>
<td align="left">No</td>
<td align="left">
<strong>Yes</strong> (NMF-LAB)</td>
</tr>
<tr class="odd">
<td align="left"><strong>Time series modeling</strong></td>
<td align="left">No</td>
<td align="left">
<strong>Yes</strong> (NMF-VAR)</td>
</tr>
<tr class="even">
<td align="left"><strong>Nonlinearity</strong></td>
<td align="left">No</td>
<td align="left">
<strong>Yes</strong> (Kernel)</td>
</tr>
<tr class="odd">
<td align="left"><strong>Clustering support</strong></td>
<td align="left">Limited</td>
<td align="left">
<strong>Yes</strong> (Hard/Soft)</td>
</tr>
<tr class="even">
<td align="left"><strong>Element-wise CV</strong></td>
<td align="left">No</td>
<td align="left"><strong>Yes</strong></td>
</tr>
</tbody>
</table>
</div>
<div class="section level1">
<h1 id="functions">Functions<a class="anchor" aria-label="anchor" href="#functions"></a>
</h1>
<p>The <strong>nmfkc</strong> package provides a comprehensive suite of functions for performing, diagnosing, and visualizing Non-negative Matrix Factorization with Kernel Covariates.</p>
<div class="section level2">
<h2 id="id_1-core-algorithm">1. Core Algorithm<a class="anchor" aria-label="anchor" href="#id_1-core-algorithm"></a>
</h2>
<p>The heart of the package is the <strong>nmfkc</strong> function, which estimates the basis matrix <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math> and parameter matrix <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math> (where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>=</mo><mi>C</mi><mi>A</mi></mrow><annotation encoding="application/x-tex">B=CA</annotation></semantics></math>) based on the observation <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math> and covariates <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>.</p>
<ul>
<li>
<strong>nmfkc</strong>: Fits the NMF model (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>≈</mo><mi>X</mi><mi>C</mi><mi>A</mi></mrow><annotation encoding="application/x-tex">Y \approx XCA</annotation></semantics></math>) using multiplicative update rules. Supports missing values (NA) and observation weights.</li>
</ul>
</div>
<div class="section level2">
<h2 id="id_2-model-selection--diagnostics">2. Model Selection &amp; Diagnostics<a class="anchor" aria-label="anchor" href="#id_2-model-selection--diagnostics"></a>
</h2>
<p>Tools to determine the optimal number of bases (Rank <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math>) and evaluate model performance.</p>
<ul>
<li>
<strong>nmfkc.rank</strong>: <strong>(Recommended)</strong> Main diagnostic tool for rank selection. Automatically suggests the optimal rank by comparing:
<ul>
<li>
<strong>Elbow Method</strong>: Based on the curvature of <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>R</mi><mn>2</mn></msup><annotation encoding="application/x-tex">R^2</annotation></semantics></math>.</li>
<li>
<strong>Wold’s CV</strong>: Based on Element-wise Cross-Validation (Min RMSE).</li>
<li>Also computes stability metrics like Cophenetic Correlation Coefficient (CPCC) and Silhouette scores.</li>
</ul>
</li>
<li>
<strong>nmfkc.ecv</strong>: Performs <strong>Element-wise Cross-Validation</strong> (Wold’s CV). Randomly masks elements of the matrix to evaluate structural reconstruction error. Theoretically robust for rank selection.</li>
<li>
<strong>nmfkc.cv</strong>: Performs <strong>Column-wise Cross-Validation</strong>. Useful for evaluating the prediction performance for new (unseen) individuals.</li>
<li>
<strong>nmfkc.residual.plot</strong>: Visualizes the original matrix, fitted matrix, and residual matrix side-by-side to check for randomness in errors.</li>
</ul>
</div>
<div class="section level2">
<h2 id="id_3-covariate-engineering">3. Covariate Engineering<a class="anchor" aria-label="anchor" href="#id_3-covariate-engineering"></a>
</h2>
<p>Functions to construct the covariate matrix <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math> from raw features <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>U</mi><annotation encoding="application/x-tex">U</annotation></semantics></math>.</p>
<ul>
<li>
<strong>nmfkc.kernel</strong>: Generates a kernel matrix (e.g., Gaussian, Polynomial) from covariates.</li>
<li>
<strong>nmfkc.ar</strong>: Constructs lagged matrices for <strong>Vector Autoregression (NMF-VAR)</strong> models.</li>
<li>
<strong>nmfkc.class</strong>: Converts categorical vectors into one-hot encoded matrices for classification tasks (NMF-LAB).</li>
</ul>
</div>
<div class="section level2">
<h2 id="id_4-parameter-tuning">4. Parameter Tuning<a class="anchor" aria-label="anchor" href="#id_4-parameter-tuning"></a>
</h2>
<p>Helper functions to optimize hyperparameters other than rank.</p>
<ul>
<li>
<strong>nmfkc.kernel.beta.cv</strong>: Optimizes the Gaussian kernel width (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>) via cross-validation.</li>
<li>
<strong>nmfkc.kernel.beta.nearest.med</strong>: Heuristically estimates <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math> using the median of nearest-neighbor distances.</li>
<li>
<strong>nmfkc.ar.degree.cv</strong>: Selects the optimal lag order (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>) for NMF-VAR models.</li>
</ul>
</div>
<div class="section level2">
<h2 id="id_5-prediction--forecasting">5. Prediction &amp; Forecasting<a class="anchor" aria-label="anchor" href="#id_5-prediction--forecasting"></a>
</h2>
<ul>
<li>
<strong>predict.nmfkc</strong>: Predicts values or classes for new covariate data (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>A</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msub><annotation encoding="application/x-tex">A_{new}</annotation></semantics></math>).</li>
<li>
<strong>nmfkc.ar.predict</strong>: Performs multi-step ahead forecasting for Time Series models.</li>
<li>
<strong>nmfkc.ar.stationarity</strong>: Checks the stationarity (stability) of the estimated VAR system.</li>
</ul>
</div>
<div class="section level2">
<h2 id="id_6-visualization-graphvizdot">6. Visualization (Graphviz/DOT)<a class="anchor" aria-label="anchor" href="#id_6-visualization-graphvizdot"></a>
</h2>
<p>Generates DOT scripts to visualize relationships between variables.</p>
<ul>
<li>
<strong>nmfkc.DOT</strong>: Visualizes the structure of standard NMF or Kernel NMF (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>→</mo><mi>X</mi><mo>→</mo><mi>Y</mi></mrow><annotation encoding="application/x-tex">A \to X \to Y</annotation></semantics></math>).</li>
<li>
<strong>nmfkc.ar.DOT</strong>: Visualizes the Granger causality network in Time Series models.</li>
</ul>
</div>
<div class="section level2">
<h2 id="id_7-utilities">7. Utilities<a class="anchor" aria-label="anchor" href="#id_7-utilities"></a>
</h2>
<ul>
<li>
<strong>nmfkc.normalize</strong> / <strong>nmfkc.denormalize</strong>: Helper functions to scale data to <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">[</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[0,1]</annotation></semantics></math> and back.</li>
</ul>
</div>
</div>
<div class="section level1">
<h1 id="statistical-model">Statistical Model<a class="anchor" aria-label="anchor" href="#statistical-model"></a>
</h1>
<p>The <strong>nmfkc</strong> package builds upon the standard NMF framework by incorporating external information (covariates). The statistical modeling process involves three steps:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Standard NMF</strong>: Let <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math> be a <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo>×</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">P \times N</annotation></semantics></math> observation matrix. Standard Non-negative Matrix Factorization approximates <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math> as the product of two non-negative matrices: <math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>≈</mo><mi>X</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">Y \approx X B</annotation></semantics></math> where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math> is the <strong>basis matrix</strong> (capturing latent patterns) and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math> is the <strong>coefficient matrix</strong> (weights for each observation). Unlike ordinary linear models where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math> is known, NMF optimizes both <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>.</p></li>
<li><p><strong>NMF with Covariates</strong>: We assume that the coefficient matrix <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math> is not arbitrary but driven by known covariates <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math> (e.g., time, location, or attributes). We model this relationship as: <math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>≈</mo><mi>C</mi><mi>A</mi></mrow><annotation encoding="application/x-tex">B \approx C A</annotation></semantics></math> where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math> is a parameter matrix mapping covariates to the latent bases.</p></li>
<li>
<p><strong>Tri-Factorization Model</strong>: Substituting <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math> yields the core model of <strong>nmfkc</strong>: <math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>≈</mo><mi>X</mi><mi>C</mi><mi>A</mi></mrow><annotation encoding="application/x-tex">Y \approx X C A</annotation></semantics></math></p>
<ul>
<li>
<strong>Kernel Extension</strong>: By constructing <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math> using a kernel function (e.g., Gaussian kernel) on raw features, the model can capture non-linear relationships (Satoh, 2024).</li>
<li>
<strong>Theoretical Roots</strong>: This formulation aligns with Orthogonal Tri-NMF (Ding et al., 2006) and generalizes the Growth Curve Models (Potthoff and Roy, 1964).</li>
</ul>
</li>
</ol>
</div>
<div class="section level1">
<h1 id="matrices">Matrices<a class="anchor" aria-label="anchor" href="#matrices"></a>
</h1>
<p>The goal of <strong>nmfkc</strong> is to optimize the unknown matrices <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>, given the observation <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math> and covariates <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>, minimizing the reconstruction error:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>P</mi><mo>,</mo><mi>N</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>≈</mo><mi>X</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>P</mi><mo>,</mo><mi>Q</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>×</mo><mi>C</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>Q</mi><mo>,</mo><mi>R</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>×</mo><mi>A</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>R</mi><mo>,</mo><mi>N</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y(P,N) \approx X(P,Q) \times C(Q,R) \times A(R,N)</annotation></semantics></math></p>
<div class="section level3">
<h3 id="given-input">Given (Input)<a class="anchor" aria-label="anchor" href="#given-input"></a>
</h3>
<ul>
<li>
<strong><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>P</mi><mo>,</mo><mi>N</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y(P,N)</annotation></semantics></math></strong>: Observation matrix (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>P</mi><annotation encoding="application/x-tex">P</annotation></semantics></math> features <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>×</mi><annotation encoding="application/x-tex">\times</annotation></semantics></math><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math> samples). Missing values are supported.</li>
<li>
<strong><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>R</mi><mo>,</mo><mi>N</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">A(R,N)</annotation></semantics></math></strong>: Covariate matrix (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math> covariates <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>×</mi><annotation encoding="application/x-tex">\times</annotation></semantics></math><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math> samples).
<ul>
<li>Can be created using <code>nmfkc.kernel</code> (for kernel methods) or <code>nmfkc.ar</code> (for time series).</li>
<li>If no covariates are provided, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math> defaults to the identity matrix (Standard NMF).</li>
</ul>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="optimized-output">Optimized (Output)<a class="anchor" aria-label="anchor" href="#optimized-output"></a>
</h3>
<ul>
<li>
<strong><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>P</mi><mo>,</mo><mi>Q</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">X(P,Q)</annotation></semantics></math></strong>: Basis matrix (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>P</mi><annotation encoding="application/x-tex">P</annotation></semantics></math> features <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>×</mi><annotation encoding="application/x-tex">\times</annotation></semantics></math><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math> bases).
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math> is the rank (number of bases), constrained by <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>≤</mo><mo>min</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>P</mi><mo>,</mo><mi>N</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Q \le \min(P,N)</annotation></semantics></math>.</li>
</ul>
</li>
<li>
<strong><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>Q</mi><mo>,</mo><mi>R</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">C(Q,R)</annotation></semantics></math></strong>: Parameter matrix (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math> bases <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>×</mi><annotation encoding="application/x-tex">\times</annotation></semantics></math><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math> covariates).
<ul>
<li>This matrix links the covariates to the latent structure.</li>
<li>Corresponds to <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Θ</mi><annotation encoding="application/x-tex">\Theta</annotation></semantics></math> in Satoh (2024).</li>
</ul>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="derived">Derived<a class="anchor" aria-label="anchor" href="#derived"></a>
</h3>
<ul>
<li>
<strong><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>Q</mi><mo>,</mo><mi>N</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">B(Q,N)</annotation></semantics></math></strong>: Coefficient matrix, calculated as <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>=</mo><mi>C</mi><mi>A</mi></mrow><annotation encoding="application/x-tex">B = C A</annotation></semantics></math>.
<ul>
<li>Represents the activation of each basis for each sample.</li>
<li>Normalized columns of <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math> (proportions) can be used for <strong>soft clustering</strong> probabilities.</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section level1">
<h1 id="source">Source<a class="anchor" aria-label="anchor" href="#source"></a>
</h1>
<ul>
<li>Satoh, K. (2024) Applying Non-negative Matrix Factorization with Covariates to the Longitudinal Data as Growth Curve Model. arXiv preprint arXiv:2403.05359. <a href="https://arxiv.org/abs/2403.05359" class="external-link uri">https://arxiv.org/abs/2403.05359</a>
</li>
<li>Satoh, K. (2025) Applying non-negative Matrix Factorization with Covariates to Multivariate Time Series Data as a Vector Autoregression Model, Japanese Journal of Statistics and Data Science, in press. <a href="https://doi.org/10.1007/s42081-025-00314-0" class="external-link uri">https://doi.org/10.1007/s42081-025-00314-0</a>
</li>
<li>Satoh, K. (2025) Applying non-negative matrix factorization with covariates to label matrix for classification. arXiv preprint arXiv:2510.10375. <a href="https://arxiv.org/abs/2510.10375" class="external-link uri">https://arxiv.org/abs/2510.10375</a>
</li>
</ul>
</div>
<div class="section level1">
<h1 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h1>
<ul>
<li>Ding, C., Li, T., Peng, W. and Park, H. (2006) Orthogonal Nonnegative Matrix Tri-Factorizations for Clustering, Proceedings of the 12th ACM SIGKDD international conference on Knowledge discovery and data mining, 126-135. <a href="https://doi.org/10.1145/1150402.1150420" class="external-link uri">https://doi.org/10.1145/1150402.1150420</a>
</li>
<li>Potthoff, R.F., and Roy, S.N. (1964). A generalized multivariate analysis of variance model useful especially for growth curve problems. Biometrika, 51, 313-326. <a href="https://doi.org/10.2307/2334137" class="external-link uri">https://doi.org/10.2307/2334137</a>
</li>
</ul>
</div>
<div class="section level1">
<h1 id="examples">Examples<a class="anchor" aria-label="anchor" href="#examples"></a>
</h1>
<p>Here are practical examples demonstrating the capabilities of <strong>nmfkc</strong>, ranging from simple matrix operations to complex time-series forecasting and classification tasks.</p>
<div class="section level2">
<h2 id="note-that-these-scripts-have-been-tested-on-windows-11">Note that these scripts have been tested on Windows 11.<a class="anchor" aria-label="anchor" href="#note-that-these-scripts-have-been-tested-on-windows-11"></a>
</h2>
<table class="table">
<colgroup>
<col width="12%">
<col width="41%">
<col width="45%">
</colgroup>
<thead><tr class="header">
<th>ID</th>
<th>Description</th>
<th>Key Features</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>Simple matrix operations</td>
<td>Basic usage, Matrix decomposition</td>
</tr>
<tr class="even">
<td>1</td>
<td>Longitudinal data (COVID-19)</td>
<td>Rank selection, Clustering on Map</td>
</tr>
<tr class="odd">
<td>2</td>
<td>Spatiotemporal Analysis (Weather)</td>
<td>
<strong>Kernel NMF</strong>, Cross-validation for beta</td>
</tr>
<tr class="even">
<td>3</td>
<td>Topic model (Inaugural address)</td>
<td>Text mining, Temporal topic evolution</td>
</tr>
<tr class="odd">
<td>4</td>
<td>OD data (Inter-prefecture flow)</td>
<td>
<strong>Sankey diagram</strong>, Stability analysis</td>
</tr>
<tr class="even">
<td>5</td>
<td>Kernel ridge regression (Motorcycle)</td>
<td>Non-linear regression, Interpolation</td>
</tr>
<tr class="odd">
<td>6</td>
<td>Growth curve model (Orthodont)</td>
<td>Handling dummy variables (Sex)</td>
</tr>
<tr class="even">
<td>7</td>
<td>Autoregression (AirPassengers)</td>
<td>
<strong>NMF-VAR</strong>, Forecasting, Stationarity check</td>
</tr>
<tr class="odd">
<td>8</td>
<td>Vector Autoregression (Canada)</td>
<td>Multivariate Time Series, <strong>Granger Causality (DOT)</strong>
</td>
</tr>
<tr class="even">
<td>9</td>
<td>Classification (Iris)</td>
<td>
<strong>NMF-LAB</strong>, Supervised learning</td>
</tr>
</tbody>
</table>
<hr>
</div>
<div class="section level2">
<h2 id="id_0-simple-matrix-operations">0. Simple matrix operations<a class="anchor" aria-label="anchor" href="#id_0-simple-matrix-operations"></a>
</h2>
<p>This example demonstrates the basic concept of NMF: decomposing a matrix <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math> into a basis matrix <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math> and a coefficient matrix <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("remotes")</span></span>
<span><span class="co"># remotes::install_github("ksatohds/nmfkc")</span></span>
<span></span>
<span><span class="co"># 1. Prepare synthetic data</span></span>
<span><span class="co"># X: Basis matrix (2 bases), B: Coefficient matrix</span></span>
<span><span class="op">(</span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">B</span><span class="op">)</span> <span class="co"># Y is the observation matrix to be decomposed</span></span>
<span></span>
<span><span class="co"># 2. Perform NMF</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ksatohds/nmfkc" class="external-link">nmfkc</a></span><span class="op">)</span></span>
<span><span class="co"># Decompose Y into X and B with Rank(Q) = 2</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.html">nmfkc</a></span><span class="op">(</span><span class="va">Y</span>, Q<span class="op">=</span><span class="fl">2</span>, epsilon<span class="op">=</span><span class="fl">1e-6</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Check results</span></span>
<span><span class="va">res</span><span class="op">$</span><span class="va">X</span> <span class="co"># Estimated Basis</span></span>
<span><span class="va">res</span><span class="op">$</span><span class="va">B</span> <span class="co"># Estimated Coefficients</span></span>
<span></span>
<span><span class="co"># 4. Diagnostics</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>    <span class="co"># Convergence plot of the objective function</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="co"># Summary statistics</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="id_1-longitudinal-data-covid-19-in-japan">1. Longitudinal data: COVID-19 in Japan<a class="anchor" aria-label="anchor" href="#id_1-longitudinal-data-covid-19-in-japan"></a>
</h2>
<p>An example of analyzing spatiotemporal data (prefecture x time). It includes <strong>Rank Selection</strong> to determine the optimal number of clusters and visualizes the results on a map.</p>
<ul>
<li>Data Source: <a href="https://www.mhlw.go.jp/stf/covid-19/open-data.html" class="external-link">https://www.mhlw.go.jp/stf/covid-19/open-data.html</a>
</li>
</ul>
<!-- end list --><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("remotes")</span></span>
<span><span class="co"># remotes::install_github("ksatohds/nmfkc")</span></span>
<span><span class="co"># install.packages("NipponMap")</span></span>
<span></span>
<span><span class="co"># 1. Data Preparation</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"https://covid19.mhlw.go.jp/public/opendata/newly_confirmed_cases_daily.csv"</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="co"># Log-transform the infection counts (excluding 'Date' and 'ALL' columns)</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">d</span><span class="op">[</span>, <span class="fl">2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="fl">47</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">Date</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Rank Selection Diagnostics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ksatohds/nmfkc" class="external-link">nmfkc</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Evaluate Ranks Q=2 to 8. </span></span>
<span><span class="co"># save.time=FALSE enables Element-wise Cross-Validation (Robust)</span></span>
<span><span class="va">result.rank</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.rank.html">nmfkc.rank</a></span><span class="op">(</span><span class="va">Y</span>, Q<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="fl">8</span>, save.time<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">result.rank</span><span class="op">$</span><span class="va">criteria</span>, <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Perform NMF with Optimal Rank (e.g., Q=3)</span></span>
<span><span class="co"># Q &lt;- result.rank$rank.best</span></span>
<span><span class="va">Q</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.html">nmfkc</a></span><span class="op">(</span><span class="va">Y</span>, Q<span class="op">=</span><span class="va">Q</span>, epsilon<span class="op">=</span><span class="fl">1e-5</span>, prefix<span class="op">=</span><span class="st">"Region"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">result</span>, type<span class="op">=</span><span class="st">"l"</span>, col<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="co"># Convergence</span></span>
<span></span>
<span><span class="co"># 4. Visualization: Individual Fit</span></span>
<span><span class="co"># Compare observed (black) vs fitted (red) for each prefecture</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>,<span class="fl">7</span><span class="op">)</span>, mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">+</span><span class="fl">0.1</span>, cex<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">Y</span><span class="op">[</span>,<span class="va">n</span><span class="op">]</span>, axes<span class="op">=</span><span class="cn">FALSE</span>, type<span class="op">=</span><span class="st">"l"</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">XB</span><span class="op">[</span>,<span class="va">n</span><span class="op">]</span>, col<span class="op">=</span><span class="fl">2</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, legend<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">[</span><span class="va">n</span><span class="op">]</span>, x.intersp<span class="op">=</span><span class="op">-</span><span class="fl">0.5</span>, bty<span class="op">=</span><span class="st">"n"</span><span class="op">)</span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/box.html" class="external-link">box</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># 5. Visualization: Temporal Patterns (Basis X)</span></span>
<span><span class="co"># Show the 3 extracted temporal patterns (Waves of infection)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Q</span>,<span class="fl">1</span><span class="op">)</span>, mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, cex<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">q</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">Q</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">X</span><span class="op">[</span>,<span class="va">q</span><span class="op">]</span>, col<span class="op">=</span><span class="va">q</span><span class="op">+</span><span class="fl">1</span>, border<span class="op">=</span><span class="va">q</span><span class="op">+</span><span class="fl">1</span>, las<span class="op">=</span><span class="fl">3</span>,</span>
<span>    ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">X</span><span class="op">)</span>, ylab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"topic "</span>, <span class="va">q</span><span class="op">)</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"left"</span>, fill<span class="op">=</span><span class="va">q</span><span class="op">+</span><span class="fl">1</span>, legend<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">q</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># 6. Visualization: Clustering on Map</span></span>
<span><span class="co"># Show which prefecture belongs to which pattern</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">NipponMap</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">4</span>,<span class="fl">4</span>,<span class="fl">2</span><span class="op">)</span><span class="op">+</span><span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">jmap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/NipponMap/man/JapanPrefMap.html" class="external-link">JapanPrefMap</a></span><span class="op">(</span>col<span class="op">=</span><span class="st">"white"</span>, axes<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Soft clustering (Pie charts on map)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/stars.html" class="external-link">stars</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">B.prob</span><span class="op">)</span>, scale<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>      locations<span class="op">=</span><span class="va">jmap</span>, key.loc<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">145</span>,<span class="fl">34</span><span class="op">)</span>,</span>
<span>      draw.segments<span class="op">=</span><span class="cn">TRUE</span>, len<span class="op">=</span><span class="fl">0.7</span>, labels<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>      col.segments<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">Q</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span>, add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Heatmap of coefficients</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/heatmap.html" class="external-link">heatmap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">B.prob</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Hard clustering (Colored map)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">NipponMap</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">4</span>,<span class="fl">4</span>,<span class="fl">2</span><span class="op">)</span><span class="op">+</span><span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">jmap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/NipponMap/man/JapanPrefMap.html" class="external-link">JapanPrefMap</a></span><span class="op">(</span>col<span class="op">=</span><span class="va">result</span><span class="op">$</span><span class="va">B.cluster</span><span class="op">+</span><span class="fl">1</span>, axes<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="id_2-spatiotemporal-analysis-canadianweather">2. Spatiotemporal Analysis: CanadianWeather<a class="anchor" aria-label="anchor" href="#id_2-spatiotemporal-analysis-canadianweather"></a>
</h2>
<p>This example compares standard NMF with <strong>Kernel NMF</strong>. By using location information as covariates (Kernel), we can predict coefficients for unobserved locations (Interpolation).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("remotes")</span></span>
<span><span class="co"># remotes::install_github("ksatohds/nmfkc")</span></span>
<span><span class="co"># install.packages("fda")</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.functionaldata.org" class="external-link">fda</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">CanadianWeather</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="va">CanadianWeather</span><span class="op">$</span><span class="va">dailyAv</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span> <span class="co"># Temperature data</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="co"># Ensure non-negative</span></span>
<span><span class="va">u0</span> <span class="op">&lt;-</span> <span class="va">CanadianWeather</span><span class="op">$</span><span class="va">coordinates</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">1</span><span class="op">]</span> <span class="co"># Lat/Lon</span></span>
<span><span class="va">u0</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">u0</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># -----------------------------------</span></span>
<span><span class="co"># Method A: Standard NMF (No Covariates)</span></span>
<span><span class="co"># -----------------------------------</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ksatohds/nmfkc" class="external-link">nmfkc</a></span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.html">nmfkc</a></span><span class="op">(</span><span class="va">Y</span>, Q<span class="op">=</span><span class="fl">2</span>, prefix<span class="op">=</span><span class="st">"Trend"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualization: Basis functions (Temperature patterns)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">4</span>,<span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">+</span><span class="fl">0.1</span>, cex<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, type<span class="op">=</span><span class="st">"n"</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">X</span><span class="op">)</span>, ylab<span class="op">=</span><span class="st">"basis function"</span><span class="op">)</span></span>
<span><span class="va">Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">X</span><span class="op">)</span>  </span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">q</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">Q</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">X</span><span class="op">[</span>,<span class="va">q</span><span class="op">]</span>, col<span class="op">=</span><span class="va">q</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, legend<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">Q</span>, fill<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">Q</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualization: Spatial Distribution</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">4</span>,<span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">+</span><span class="fl">0.1</span>, cex<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">u0</span>, pch<span class="op">=</span><span class="fl">19</span>, cex<span class="op">=</span><span class="fl">3</span>, col<span class="op">=</span><span class="va">result</span><span class="op">$</span><span class="va">B.cluster</span><span class="op">+</span><span class="fl">1</span>, main<span class="op">=</span><span class="st">"Hard Clustering"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html" class="external-link">text</a></span><span class="op">(</span><span class="va">u0</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>, pos<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -----------------------------------</span></span>
<span><span class="co"># Method B: NMF with Covariates (Linear)</span></span>
<span><span class="co"># -----------------------------------</span></span>
<span><span class="co"># Using raw coordinates as covariates A</span></span>
<span><span class="va">U</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="reference/nmfkc.normalize.html">nmfkc.normalize</a></span><span class="op">(</span><span class="va">u0</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">U</span><span class="op">)</span> <span class="co"># Add intercept</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.html">nmfkc</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">A</span>, Q<span class="op">=</span><span class="fl">2</span>, prefix<span class="op">=</span><span class="st">"Trend"</span><span class="op">)</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">r.squared</span></span>
<span></span>
<span><span class="co"># -----------------------------------</span></span>
<span><span class="co"># Method C: NMF with Covariates (Gaussian Kernel)</span></span>
<span><span class="co"># -----------------------------------</span></span>
<span><span class="co"># A is constructed using a Kernel function of locations U.</span></span>
<span><span class="co"># K(u,v) = exp{-beta * |u-v|^2}</span></span>
<span></span>
<span><span class="co"># 1. Optimize Gaussian kernel parameter (beta) via Cross-Validation</span></span>
<span><span class="va">result.beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.kernel.beta.cv.html">nmfkc.kernel.beta.cv</a></span><span class="op">(</span><span class="va">Y</span>, Q<span class="op">=</span><span class="fl">2</span>, U<span class="op">=</span><span class="va">U</span>, beta<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">best.beta</span> <span class="op">&lt;-</span> <span class="va">result.beta</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Perform Kernel NMF</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.kernel.html">nmfkc.kernel</a></span><span class="op">(</span><span class="va">U</span>, beta<span class="op">=</span><span class="va">best.beta</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.html">nmfkc</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">A</span>, Q<span class="op">=</span><span class="fl">2</span>, prefix<span class="op">=</span><span class="st">"Trend"</span><span class="op">)</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">r.squared</span> </span>
<span></span>
<span><span class="co"># 3. Prediction / Interpolation on a Mesh</span></span>
<span><span class="co"># Predict coefficients B for new locations V</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from<span class="op">=</span><span class="fl">0</span>, to<span class="op">=</span><span class="fl">1</span>, length<span class="op">=</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">V</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span><span class="va">v</span>,<span class="va">v</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># Grid points</span></span>
<span><span class="va">A_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.kernel.html">nmfkc.kernel</a></span><span class="op">(</span><span class="va">U</span>, <span class="va">V</span>, beta<span class="op">=</span><span class="va">best.beta</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># B_new = C * A_new</span></span>
<span><span class="va">B</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">C</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">A_new</span></span>
<span><span class="va">B.prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proportions.html" class="external-link">prop.table</a></span><span class="op">(</span><span class="va">B</span>, <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize estimated probability surface</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">B.prob</span><span class="op">[</span><span class="va">q</span>,<span class="op">]</span>, nrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">4</span>,<span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">+</span><span class="fl">0.1</span>, cex<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/filled.contour.html" class="external-link">filled.contour</a></span><span class="op">(</span><span class="va">v</span>, <span class="va">v</span>, <span class="va">z</span>, main<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Predicted Probability of Pattern "</span>,<span class="va">q</span><span class="op">)</span>,</span>
<span>  color.palette <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="va">n</span>, <span class="st">"Greens3"</span>, rev<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  plot.axes<span class="op">=</span><span class="op">{</span></span>
<span>     <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">U</span><span class="op">)</span>, col<span class="op">=</span><span class="fl">7</span>, pch<span class="op">=</span><span class="fl">19</span><span class="op">)</span></span>
<span>     <span class="fu"><a href="https://rdrr.io/r/graphics/text.html" class="external-link">text</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">U</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">U</span><span class="op">)</span>, pos<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="id_3-topic-model-us-presidential-inaugural-addresses">3. Topic model: US Presidential Inaugural Addresses<a class="anchor" aria-label="anchor" href="#id_3-topic-model-us-presidential-inaugural-addresses"></a>
</h2>
<p>Application to text mining. NMF extracts topics (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>) and their weights (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>). By using “Year” as a covariate, we can visualize how <strong>topics evolve over time</strong>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("remotes")</span></span>
<span><span class="co"># remotes::install_github("ksatohds/nmfkc")</span></span>
<span><span class="co"># install.packages("quanteda")</span></span>
<span></span>
<span><span class="co"># 1. Text Preprocessing using quanteda</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://quanteda.io" class="external-link">quanteda</a></span><span class="op">)</span></span>
<span><span class="va">corp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://quanteda.io/reference/corpus.html" class="external-link">corpus</a></span><span class="op">(</span><span class="va">data_corpus_inaugural</span><span class="op">)</span></span>
<span><span class="va">tok</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://quanteda.io/reference/tokens.html" class="external-link">tokens</a></span><span class="op">(</span><span class="va">corp</span><span class="op">)</span></span>
<span><span class="va">tok</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://quanteda.io/reference/tokens_select.html" class="external-link">tokens_remove</a></span><span class="op">(</span><span class="va">tok</span>, pattern<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/stopwords/man/stopwords.html" class="external-link">stopwords</a></span><span class="op">(</span><span class="st">"en"</span>, source<span class="op">=</span><span class="st">"snowball"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://quanteda.io/reference/dfm.html" class="external-link">dfm</a></span><span class="op">(</span><span class="va">tok</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://quanteda.io/reference/dfm_select.html" class="external-link">dfm_select</a></span><span class="op">(</span><span class="va">df</span>, min_nchar<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://quanteda.io/reference/dfm_trim.html" class="external-link">dfm_trim</a></span><span class="op">(</span><span class="va">df</span>, min_termfreq<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="co"># Sort by frequency</span></span>
<span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span>, decreasing<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> </span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">[</span>,<span class="va">index</span><span class="op">]</span> </span>
<span></span>
<span><span class="co"># -----------------------------------</span></span>
<span><span class="co"># Standard Topic Model (NMF)</span></span>
<span><span class="co"># -----------------------------------</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="co"># Term-Document Matrix</span></span>
<span><span class="va">Q</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ksatohds/nmfkc" class="external-link">nmfkc</a></span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.html">nmfkc</a></span><span class="op">(</span><span class="va">Y</span>, Q<span class="op">=</span><span class="va">Q</span>, prefix<span class="op">=</span><span class="st">"Topic"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Interpret Topics (High probability words)</span></span>
<span><span class="va">Xp</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">X.prob</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">q</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">Q</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"----- Featured words on Topic ["</span>, <span class="va">q</span>, <span class="st">"] -----"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">Xp</span><span class="op">)</span>, <span class="st">"("</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>, <span class="st">") "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">100</span><span class="op">*</span><span class="va">Xp</span><span class="op">[</span>,<span class="va">q</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"%"</span><span class="op">)</span><span class="op">[</span><span class="va">Xp</span><span class="op">[</span>,<span class="va">q</span><span class="op">]</span><span class="op">&gt;=</span><span class="fl">0.5</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Visualize Topic Proportions per President</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">4</span>,<span class="fl">4</span>,<span class="fl">2</span><span class="op">)</span><span class="op">+</span><span class="fl">0.1</span>, cex<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">B.prob</span>, col<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">Q</span><span class="op">+</span><span class="fl">1</span>, legend<span class="op">=</span><span class="cn">TRUE</span>, las<span class="op">=</span><span class="fl">3</span>,</span>
<span>  ylab<span class="op">=</span><span class="st">"Probabilities of topics"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -----------------------------------</span></span>
<span><span class="co"># Temporal Topic Model (Kernel NMF)</span></span>
<span><span class="co"># -----------------------------------</span></span>
<span><span class="co"># Use 'Year' as covariate to smooth topic trends</span></span>
<span><span class="va">U</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">corp</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Optimize beta</span></span>
<span><span class="va">result.beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.kernel.beta.cv.html">nmfkc.kernel.beta.cv</a></span><span class="op">(</span><span class="va">Y</span>, Q<span class="op">=</span><span class="fl">3</span>, <span class="va">U</span>, beta<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span><span class="op">/</span><span class="fl">10000</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">best.beta</span> <span class="op">&lt;-</span> <span class="va">result.beta</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Perform Kernel NMF</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.kernel.html">nmfkc.kernel</a></span><span class="op">(</span><span class="va">U</span>, beta<span class="op">=</span><span class="va">best.beta</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.html">nmfkc</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">A</span>, <span class="va">Q</span>, prefix<span class="op">=</span><span class="st">"Topic"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize Smooth Topic Evolution</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">B.prob</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">corp</span><span class="op">$</span><span class="va">Year</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">4</span>,<span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">+</span><span class="fl">0.1</span>, cex<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">B.prob</span>, col<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">Q</span><span class="op">+</span><span class="fl">1</span>, legend<span class="op">=</span><span class="cn">TRUE</span>, las<span class="op">=</span><span class="fl">3</span>, </span>
<span>        ylab<span class="op">=</span><span class="st">"Probability of topic (Smoothed)"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="id_4-origin-destination-od-data">4. Origin-Destination (OD) data<a class="anchor" aria-label="anchor" href="#id_4-origin-destination-od-data"></a>
</h2>
<p>Analyzing flow data between prefectures. This example uses <strong>Sankey diagrams</strong> to visualize the stability of clustering results across different ranks (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math>).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("remotes")</span></span>
<span><span class="co"># remotes::install_github("ksatohds/nmfkc")</span></span>
<span><span class="co"># install.packages("httr")</span></span>
<span><span class="co"># install.packages("readxl")</span></span>
<span><span class="co"># install.packages("alluvial")</span></span>
<span><span class="co"># install.packages("NipponMap")</span></span>
<span><span class="co"># install.packages("RColorBrewer")</span></span>
<span></span>
<span><span class="co"># 1. Data Download &amp; Formatting (Japanese OD data)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://httr.r-lib.org/" class="external-link">httr</a></span><span class="op">)</span></span>
<span><span class="va">url</span> <span class="op">&lt;-</span> <span class="st">"https://www.e-stat.go.jp/stat-search/file-download?statInfId=000040170612&amp;fileKind=0"</span></span>
<span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">GET</a></span><span class="op">(</span><span class="va">url</span>, <span class="fu"><a href="https://httr.r-lib.org/reference/write_disk.html" class="external-link">write_disk</a></span><span class="op">(</span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext<span class="op">=</span><span class="st">".xlsx"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readxl.tidyverse.org" class="external-link">readxl</a></span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html" class="external-link">read_xlsx</a></span><span class="op">(</span><span class="va">tmp</span>, sheet<span class="op">=</span><span class="fl">1</span>, skip<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Filter for specific flow type</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">[</span><span class="va">d</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">==</span><span class="st">"1"</span> <span class="op">&amp;</span> <span class="va">d</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">==</span><span class="st">"02"</span> <span class="op">&amp;</span> <span class="va">d</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span><span class="op">!=</span><span class="st">"100"</span> <span class="op">&amp;</span> <span class="va">d</span><span class="op">[</span>,<span class="fl">7</span><span class="op">]</span><span class="op">!=</span><span class="st">"100"</span>, <span class="op">]</span></span>
<span><span class="va">pref</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span>,<span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create OD Matrix Y (47x47)</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow<span class="op">=</span><span class="fl">47</span>, ncol<span class="op">=</span><span class="fl">47</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">pref</span></span>
<span><span class="va">d</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span><span class="op">)</span>; <span class="va">d</span><span class="op">[</span>,<span class="fl">7</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span>,<span class="fl">7</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">47</span><span class="op">)</span> <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">47</span><span class="op">)</span> <span class="va">Y</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span><span class="op">==</span><span class="va">i</span> <span class="op">&amp;</span> <span class="va">d</span><span class="op">[</span>,<span class="fl">7</span><span class="op">]</span><span class="op">==</span><span class="va">j</span><span class="op">)</span>, <span class="fl">9</span><span class="op">]</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">Y</span><span class="op">)</span> <span class="co"># Log transformation</span></span>
<span></span>
<span><span class="co"># 2. Rank Selection &amp; Diagnostic Plot</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ksatohds/nmfkc" class="external-link">nmfkc</a></span><span class="op">)</span></span>
<span><span class="co"># Check AIC, BIC, RSS for Q=2 to 12</span></span>
<span><span class="fu"><a href="reference/nmfkc.rank.html">nmfkc.rank</a></span><span class="op">(</span><span class="va">Y</span>, Q<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="fl">12</span>, save.time<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. NMF Analysis (Q=7)</span></span>
<span><span class="va">Q0</span> <span class="op">&lt;-</span> <span class="fl">7</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.html">nmfkc</a></span><span class="op">(</span><span class="va">Y</span>, Q<span class="op">=</span><span class="va">Q0</span>, save.time<span class="op">=</span><span class="cn">FALSE</span>, prefix<span class="op">=</span><span class="st">"Region"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4. Visualization: Silhouette Plot</span></span>
<span><span class="va">si</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">criterion</span><span class="op">$</span><span class="va">silhouette</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="va">si</span><span class="op">$</span><span class="va">silhouette</span>, horiz<span class="op">=</span><span class="cn">TRUE</span>, las<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="va">si</span><span class="op">$</span><span class="va">cluster</span><span class="op">+</span><span class="fl">1</span>, </span>
<span>        cex.names<span class="op">=</span><span class="fl">0.5</span>, xlab<span class="op">=</span><span class="st">"Silhouette width"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="va">si</span><span class="op">$</span><span class="va">silhouette.mean</span>, lty<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 5. Visualization: Sankey Diagram (Stability Analysis)</span></span>
<span><span class="co"># Visualize how clusters change as Q increases from 6 to 8</span></span>
<span><span class="va">Q</span> <span class="op">&lt;-</span> <span class="fl">6</span><span class="op">:</span><span class="fl">8</span></span>
<span><span class="va">cluster</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Q</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">res_tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.html">nmfkc</a></span><span class="op">(</span><span class="va">Y</span>, Q<span class="op">=</span><span class="va">Q</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">cluster</span>, <span class="va">res_tmp</span><span class="op">$</span><span class="va">B.cluster</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mbojan/alluvial" class="external-link">alluvial</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/alluvial/man/alluvial.html" class="external-link">alluvial</a></span><span class="op">(</span><span class="va">cluster</span>, freq<span class="op">=</span><span class="fl">1</span>, axis_labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Q="</span>, <span class="va">Q</span><span class="op">)</span>, cex<span class="op">=</span><span class="fl">2</span>,</span>
<span>         col<span class="op">=</span><span class="va">cluster</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span>, border<span class="op">=</span><span class="va">cluster</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Cluster evolution (Sankey Diagram)"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 6. Visualization: Map</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">NipponMap</span><span class="op">)</span>; <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">RColorBrewer</span><span class="op">)</span></span>
<span><span class="va">mypalette</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span><span class="fl">12</span>, <span class="st">"Paired"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">4</span>,<span class="fl">4</span>,<span class="fl">2</span><span class="op">)</span><span class="op">+</span><span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">jmap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/NipponMap/man/JapanPrefMap.html" class="external-link">JapanPrefMap</a></span><span class="op">(</span>col<span class="op">=</span><span class="va">mypalette</span><span class="op">[</span><span class="va">res</span><span class="op">$</span><span class="va">B.cluster</span><span class="op">]</span>, axes<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html" class="external-link">text</a></span><span class="op">(</span><span class="va">jmap</span>, <span class="va">pref</span>, cex<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span>  </span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span>main<span class="op">=</span><span class="st">"OD Clustering Result"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="id_5-kernel-ridge-regression">5. Kernel ridge regression<a class="anchor" aria-label="anchor" href="#id_5-kernel-ridge-regression"></a>
</h2>
<p>Demonstrates that <strong>nmfkc</strong> can be used for non-linear regression (smoothing) by treating 1D data as a matrix row and using Gaussian kernels.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("remotes")</span></span>
<span><span class="co"># remotes::install_github("ksatohds/nmfkc")</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">MASS</a></span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="va">mcycle</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">$</span><span class="va">times</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">$</span><span class="va">accel</span></span>
<span><span class="co"># Treat Y as a 1 x N matrix</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">U</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1. Linear Regression (NMF with Linear Covariate)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">U</span><span class="op">)</span> <span class="co"># Intercept + Linear term</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ksatohds/nmfkc" class="external-link">nmfkc</a></span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.html">nmfkc</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">A</span>, Q<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">4</span>,<span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">+</span><span class="fl">0.1</span>, cex<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">U</span>, <span class="va">Y</span>, main<span class="op">=</span><span class="st">"Linear Fit"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">U</span>, <span class="va">result</span><span class="op">$</span><span class="va">XB</span>, col<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Kernel Regression (Gaussian Kernel)</span></span>
<span><span class="co"># Optimize beta via Cross-Validation</span></span>
<span><span class="va">result.beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.kernel.beta.cv.html">nmfkc.kernel.beta.cv</a></span><span class="op">(</span><span class="va">Y</span>, Q<span class="op">=</span><span class="fl">1</span>, <span class="va">U</span>, beta<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">beta.best</span> <span class="op">&lt;-</span> <span class="va">result.beta</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span>  </span>
<span></span>
<span><span class="co"># Create Kernel Matrix</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.kernel.html">nmfkc.kernel</a></span><span class="op">(</span><span class="va">U</span>, beta<span class="op">=</span><span class="va">beta.best</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.html">nmfkc</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">A</span>, Q<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot Fitted Curve (Smoothing)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">U</span>, <span class="va">Y</span>, main<span class="op">=</span><span class="st">"Kernel Smoothing"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">U</span>, <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">XB</span><span class="op">)</span>, col<span class="op">=</span><span class="fl">2</span>, lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prediction on new data points</span></span>
<span><span class="va">V</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">U</span><span class="op">)</span>, to<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">U</span><span class="op">)</span>, length<span class="op">=</span><span class="fl">100</span><span class="op">)</span>, ncol<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">A_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.kernel.html">nmfkc.kernel</a></span><span class="op">(</span><span class="va">U</span>, <span class="va">V</span>, beta<span class="op">=</span><span class="va">beta.best</span><span class="op">)</span></span>
<span><span class="va">XB_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">result</span>, newA<span class="op">=</span><span class="va">A_new</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">V</span>, <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">XB_new</span><span class="op">)</span>, col<span class="op">=</span><span class="fl">4</span>, lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="id_6-growth-curve-model">6. Growth curve model<a class="anchor" aria-label="anchor" href="#id_6-growth-curve-model"></a>
</h2>
<p>Analysis of repeated measures (Growth Curve). Shows how to incorporate categorical covariates (Sex) into the <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math> matrix to analyze group differences.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("remotes")</span></span>
<span><span class="co"># remotes::install_github("ksatohds/nmfkc")</span></span>
<span><span class="co"># install.packages("nlme")</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://svn.r-project.org/R-packages/trunk/nlme/" class="external-link">nlme</a></span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="va">Orthodont</span></span>
<span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">age</span><span class="op">)</span></span>
<span><span class="co"># Matrix: Age x Subject</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">distance</span>, nrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">Subject</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">t</span></span>
<span></span>
<span><span class="co"># 1. Construct Covariate Matrix A</span></span>
<span><span class="co"># Include Intercept and Dummy variable for Male</span></span>
<span><span class="va">Male</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">*</span> <span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">Sex</span> <span class="op">==</span> <span class="st">"Male"</span><span class="op">)</span><span class="op">[</span><span class="va">d</span><span class="op">$</span><span class="va">age</span> <span class="op">==</span> <span class="fl">8</span><span class="op">]</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span>, <span class="va">Male</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Const"</span>, <span class="st">"Male"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Perform NMF with Covariates</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ksatohds/nmfkc" class="external-link">nmfkc</a></span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.html">nmfkc</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">A</span>, Q<span class="op">=</span><span class="fl">2</span>, epsilon<span class="op">=</span><span class="fl">1e-8</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Check Coefficients</span></span>
<span><span class="co"># B = C * A. We can see the coefficients for Male vs Female.</span></span>
<span><span class="op">(</span><span class="va">A0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># Unique patterns (Female, Male)</span></span>
<span><span class="va">B</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">C</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">A0</span></span>
<span></span>
<span><span class="co"># 4. Visualization</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">Y</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>, type<span class="op">=</span><span class="st">"n"</span>, ylab<span class="op">=</span><span class="st">"Distance"</span>, xlab<span class="op">=</span><span class="st">"Age"</span><span class="op">)</span></span>
<span><span class="va">mycol</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">Male</span><span class="op">==</span><span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">Y</span><span class="op">[</span>,<span class="va">n</span><span class="op">]</span>, col<span class="op">=</span><span class="va">mycol</span><span class="op">[</span><span class="va">n</span><span class="op">]</span><span class="op">)</span> <span class="co"># Individual trajectories</span></span>
<span><span class="op">}</span></span>
<span><span class="va">XB</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">B</span></span>
<span><span class="co"># Mean trajectories</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">XB</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, col<span class="op">=</span><span class="fl">4</span>, lwd<span class="op">=</span><span class="fl">5</span><span class="op">)</span> <span class="co"># Male</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">XB</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, col<span class="op">=</span><span class="fl">2</span>, lwd<span class="op">=</span><span class="fl">5</span><span class="op">)</span> <span class="co"># Female</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, title<span class="op">=</span><span class="st">"Sex"</span>, legend<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Male"</span>, <span class="st">"Female"</span><span class="op">)</span>, fill<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="id_7-autoregression-airpassengers-nmf-var">7. Autoregression: AirPassengers (NMF-VAR)<a class="anchor" aria-label="anchor" href="#id_7-autoregression-airpassengers-nmf-var"></a>
</h2>
<p><strong>nmfkc</strong> can perform Vector Autoregression (NMF-VAR). This example includes <strong>Lag Order Selection</strong> and <strong>Future Forecasting</strong>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ksatohds/nmfkc" class="external-link">nmfkc</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/ts.html" class="external-link">is.ts</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># --- 1. Lag Order Selection ---</span></span>
<span><span class="co"># Perform cross-validation to select the optimal lag order (degree).</span></span>
<span><span class="co"># We evaluate degrees 1 to 15 to capture potential seasonality (e.g., lag 12).</span></span>
<span><span class="fu"><a href="reference/nmfkc.ar.degree.cv.html">nmfkc.ar.degree.cv</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">d</span>, degree<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">15</span>, epsilon<span class="op">=</span><span class="fl">1e-5</span>, maxit<span class="op">=</span><span class="fl">50000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># --- 2. Model Construction (NMF-VAR) ---</span></span>
<span><span class="co"># Construct the observation matrix (Y) and covariate matrix (A) for NMF-VAR.</span></span>
<span><span class="co"># We use degree=12 to account for the annual seasonality of the monthly data.</span></span>
<span><span class="co"># 'intercept=TRUE' adds an intercept term to the covariate matrix.</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.ar.html">nmfkc.ar</a></span><span class="op">(</span><span class="va">d</span>, degree <span class="op">=</span> <span class="fl">12</span>, intercept <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">a</span><span class="op">$</span><span class="va">Y</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="va">a</span><span class="op">$</span><span class="va">A</span></span>
<span></span>
<span><span class="co"># --- 3. Model Fitting ---</span></span>
<span><span class="co"># Fit the NMF-VAR model (Y approx X * C * A).</span></span>
<span><span class="co"># We use Rank (Q) = 1 for this univariate time series.</span></span>
<span><span class="co"># Stricter convergence criteria (epsilon, maxit) are used for precision.</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.html">nmfkc</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>, A<span class="op">=</span><span class="va">A</span>, Q<span class="op">=</span><span class="fl">1</span>, epsilon<span class="op">=</span><span class="fl">1e-6</span>, maxit<span class="op">=</span><span class="fl">50000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display the summary of the fitted model (R-squared, sparsity, etc.).</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># --- 4. Forecasting ---</span></span>
<span><span class="co"># Compute multi-step-ahead forecasts (recursive forecasting).</span></span>
<span><span class="co"># We predict for the next 24 time points (2 years).</span></span>
<span><span class="va">pred_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.ar.predict.html">nmfkc.ar.predict</a></span><span class="op">(</span><span class="va">res</span>, Y <span class="op">=</span> <span class="va">Y</span>, n.ahead <span class="op">=</span> <span class="fl">24</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># --- 5. Data Preparation for Plotting ---</span></span>
<span><span class="co"># Extract time points from column names (automatically handled by nmfkc.ar).</span></span>
<span><span class="va">time_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Back-transform values from log10 scale to original scale.</span></span>
<span><span class="va">vals_obs</span> <span class="op">&lt;-</span> <span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>        <span class="co"># Observed values</span></span>
<span><span class="va">vals_fit</span> <span class="op">&lt;-</span> <span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">XB</span><span class="op">)</span>   <span class="co"># Fitted values (Learning phase)</span></span>
<span></span>
<span><span class="co"># Prepare forecast data (time and values).</span></span>
<span><span class="va">time_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pred_res</span><span class="op">$</span><span class="va">pred</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">vals_pred</span> <span class="op">&lt;-</span> <span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">pred_res</span><span class="op">$</span><span class="va">pred</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Determine plot limits to include both observed and predicted data.</span></span>
<span><span class="va">xlim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">time_obs</span>, <span class="va">time_pred</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ylim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vals_obs</span>, <span class="va">vals_pred</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># --- 6. Visualization ---</span></span>
<span><span class="co"># Plot the observed data (Gray line).</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">time_obs</span>, <span class="va">vals_obs</span>, type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="st">"gray"</span>, lwd <span class="op">=</span> <span class="fl">2</span>,</span>
<span>     xlim <span class="op">=</span> <span class="va">xlim</span>, ylim <span class="op">=</span> <span class="va">ylim</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"AirPassengers: NMF-VAR Forecast"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Year"</span>, ylab <span class="op">=</span> <span class="st">"Passengers (Thousands)"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add the fitted values (Blue line).</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">time_obs</span>, <span class="va">vals_fit</span>, col <span class="op">=</span> <span class="st">"blue"</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add the forecast values (Red line).</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">time_pred</span>, <span class="va">vals_pred</span>, col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add a vertical line indicating the start of the forecast period.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">time_pred</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"black"</span>, lty <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add a legend.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Observed"</span>, <span class="st">"Fitted"</span>, <span class="st">"Forecast"</span><span class="op">)</span>,</span>
<span>       col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gray"</span>, <span class="st">"blue"</span>, <span class="st">"red"</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="id_8-vector-autoregression-canada-multivariate">8. Vector Autoregression: Canada (Multivariate)<a class="anchor" aria-label="anchor" href="#id_8-vector-autoregression-canada-multivariate"></a>
</h2>
<p>Multivariate NMF-VAR example. It also demonstrates how to visualize Granger causality using <strong>DOT graphs</strong>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ksatohds/nmfkc" class="external-link">nmfkc</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.pfaffikus.de" class="external-link">vars</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1. Data Preparation (Keep 'ts' class!)</span></span>
<span><span class="va">d0</span> <span class="op">&lt;-</span> <span class="va">Canada</span>  <span class="co"># ts object</span></span>
<span></span>
<span><span class="co"># Difference and Normalize</span></span>
<span><span class="co"># apply() strips 'ts' class, so we must restore it to use nmfkc.ar's feature</span></span>
<span><span class="va">dd_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">d0</span>, <span class="fl">2</span>, <span class="va">diff</span><span class="op">)</span></span>
<span><span class="va">dd_ts</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ts.html" class="external-link">ts</a></span><span class="op">(</span><span class="va">dd_mat</span>, start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">time</a></span><span class="op">(</span><span class="va">d0</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, frequency <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">d0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Normalize (returns matrix, so restore 'ts' again)</span></span>
<span><span class="va">dn_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.normalize.html">nmfkc.normalize</a></span><span class="op">(</span><span class="va">dd_ts</span><span class="op">)</span></span>
<span><span class="va">dn_ts</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ts.html" class="external-link">ts</a></span><span class="op">(</span><span class="va">dn_mat</span>, start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/start.html" class="external-link">start</a></span><span class="op">(</span><span class="va">dd_ts</span><span class="op">)</span>, frequency <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">dd_ts</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. NMF-VAR Matrix Construction</span></span>
<span><span class="co"># [Point] Pass the 'ts' object (Time x Var) DIRECTLY!</span></span>
<span><span class="co"># nmfkc.ar will detect it, transpose it to (Var x Time), and preserve time info.</span></span>
<span><span class="va">Q</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">ar_set</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.ar.html">nmfkc.ar</a></span><span class="op">(</span><span class="va">dn_ts</span>, degree <span class="op">=</span> <span class="va">D</span>, intercept <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">ar_set</span><span class="op">$</span><span class="va">Y</span> <span class="co"># Has time-based colnames!</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="va">ar_set</span><span class="op">$</span><span class="va">A</span> <span class="co"># Has time-based colnames!</span></span>
<span></span>
<span><span class="co"># 3. Fit Model</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.html">nmfkc</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">Y</span>, A <span class="op">=</span> <span class="va">A</span>, Q <span class="op">=</span> <span class="va">Q</span>, prefix <span class="op">=</span> <span class="st">"Condition"</span>, epsilon <span class="op">=</span> <span class="fl">1e-6</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4. Visualization (Using preserved time info)</span></span>
<span><span class="co"># No need to manually reconstruct 'ts' objects or calculate time axes.</span></span>
<span><span class="co"># The colnames of Y and res$XB are already "1980.25", "1980.50", etc.</span></span>
<span></span>
<span><span class="va">time_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span> <span class="co"># Extract time from colnames</span></span>
<span></span>
<span><span class="co"># Plot Condition 1 (e.g., Employment/Productivity factor)</span></span>
<span><span class="co"># res$B.prob contains soft clustering probabilities</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">B.prob</span>, </span>
<span>        col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tomato"</span>, <span class="st">"turquoise"</span><span class="op">)</span>, </span>
<span>        border <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>        names.arg <span class="op">=</span> <span class="va">time_vec</span>, <span class="co"># Use time directly!</span></span>
<span>        las <span class="op">=</span> <span class="fl">2</span>, cex.names <span class="op">=</span> <span class="fl">0.6</span>,</span>
<span>        main <span class="op">=</span> <span class="st">"Economic Conditions (Soft Clustering)"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Probability"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"bottomright"</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">B.prob</span><span class="op">)</span>, </span>
<span>       fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tomato"</span>, <span class="st">"turquoise"</span><span class="op">)</span>, bty <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot Fitted Values for a variable (e.g., Employment 'e')</span></span>
<span><span class="co"># Row 1 of Y corresponds to variable 'e'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">time_vec</span>, <span class="va">Y</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>, type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="st">"gray"</span>, lwd <span class="op">=</span> <span class="fl">2</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Employment (Normalized Diff)"</span>, xlab <span class="op">=</span> <span class="st">"Year"</span>, ylab <span class="op">=</span> <span class="st">"Value"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">time_vec</span>, <span class="va">res</span><span class="op">$</span><span class="va">XB</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>, col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Observed"</span>, <span class="st">"Fitted"</span><span class="op">)</span>, </span>
<span>       col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gray"</span>, <span class="st">"red"</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span>, bty <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="id_9-classification-iris-nmf-lab">9. Classification: Iris (NMF-LAB)<a class="anchor" aria-label="anchor" href="#id_9-classification-iris-nmf-lab"></a>
</h2>
<p><strong>NMF-LAB</strong> (Label-based NMF) example. By treating class labels as the target matrix <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math> (one-hot encoding) and features as covariates <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>U</mi><annotation encoding="application/x-tex">U</annotation></semantics></math> (kernelized to <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>), NMF can be used for <strong>Supervised Learning</strong>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("remotes")</span></span>
<span><span class="co"># remotes::install_github("ksatohds/nmfkc")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ksatohds/nmfkc" class="external-link">nmfkc</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1. Data Preparation</span></span>
<span><span class="va">label</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">$</span><span class="va">Species</span></span>
<span><span class="co"># Convert labels to One-Hot Matrix Y</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.class.html">nmfkc.class</a></span><span class="op">(</span><span class="va">label</span><span class="op">)</span> </span>
<span><span class="co"># Features Matrix U (Normalized)</span></span>
<span><span class="va">U</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="reference/nmfkc.normalize.html">nmfkc.normalize</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>,<span class="op">-</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Kernel Parameter Optimization</span></span>
<span><span class="co"># Heuristic estimation of beta (Median distance)</span></span>
<span><span class="va">res.beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.kernel.beta.nearest.med.html">nmfkc.kernel.beta.nearest.med</a></span><span class="op">(</span><span class="va">U</span><span class="op">)</span></span>
<span><span class="co"># Cross-validation for fine-tuning</span></span>
<span><span class="va">res.cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.kernel.beta.cv.html">nmfkc.kernel.beta.cv</a></span><span class="op">(</span><span class="va">Y</span>, Q<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">label</span><span class="op">)</span><span class="op">)</span>, <span class="va">U</span>, beta<span class="op">=</span><span class="va">res.beta</span><span class="op">$</span><span class="va">beta_candidates</span><span class="op">)</span></span>
<span><span class="va">best.beta</span> <span class="op">&lt;-</span> <span class="va">res.cv</span><span class="op">$</span><span class="va">beta</span></span>
<span></span>
<span><span class="co"># 3. Fit NMF-LAB Model</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.kernel.html">nmfkc.kernel</a></span><span class="op">(</span><span class="va">U</span>, beta<span class="op">=</span><span class="va">best.beta</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nmfkc.html">nmfkc</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>, A<span class="op">=</span><span class="va">A</span>, Q<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">label</span><span class="op">)</span><span class="op">)</span>, prefix<span class="op">=</span><span class="st">"Class"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4. Prediction and Evaluation</span></span>
<span><span class="co"># Predict class based on highest probability in XB</span></span>
<span><span class="va">fitted.label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">res</span>, type<span class="op">=</span><span class="st">"class"</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">fitted.label</span>, <span class="va">label</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Accuracy: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"%"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level1">
<h1 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a>
</h1>
<ul>
<li>Kenichi Satoh, <a href="https://sites.google.com/view/ksatoh/english" class="external-link">homepage</a>
</li>
</ul>
</div>

  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/ksatohds/nmfkc/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/ksatohds/nmfkc/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing nmfkc</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Kenichi Satoh <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0003-4436-9347" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kenichi Satoh.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
